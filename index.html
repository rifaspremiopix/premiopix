<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Pix da Sorte @LeehFerriiOficial - Online e Profissional</title>
<meta name="theme-color" content="#0a1b3f" />
<style>
  :root{
    --bg:#0a1b3f;
    --card:#0f274f;
    --muted:#143369;
    --text:#ffffff;
    --accent:#ff7a00;
    --accent-2:#ffb066;
    --ok:#22c55e;
    --sold:#b5b9c7;
    --ghost:#7082a8;
    --danger:#ff5a5a;
    --shadow:0 12px 30px rgba(0,0,0,.35), 0 3px 8px rgba(0,0,0,.25);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(180deg,var(--bg),#091434);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  a{color:var(--accent)}
  header{padding:28px 16px;text-align:center;background:linear-gradient(180deg,#0d224a,rgba(13,34,74,.4));position:sticky;top:0;z-index:10;backdrop-filter:saturate(120%) blur(4px)}
  header h1{margin:0;font-size:clamp(22px,4vw,32px)}
  header p{margin:6px 0 0 0;opacity:.9}
  .rating{margin-top:8px}
  .container{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.04));border:1px solid rgba(255,255,255,.18);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .grid{display:grid;gap:16px}
  .rifa {display:grid;gap:12px}
  .rifa h2{margin:0 0 4px 0;font-size:22px}
  .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:14px;opacity:.95}
  .pill{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);padding:6px 10px;border-radius:999px}
  .legend{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;margin-top:6px}
  .dot{width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:6px;vertical-align:-1px}
  .numbers{display:grid;gap:6px;margin-top:10px;grid-template-columns:repeat(auto-fill,minmax(36px,1fr));}
  @media(max-width:480px){.numbers{grid-template-columns:repeat(auto-fill,minmax(30px,1fr));gap:4px}}
  .num{user-select:none;text-align:center;padding:8px 0;border-radius:10px;font-weight:600;font-size:12px;cursor:pointer;border:1px solid rgba(255,255,255,.3)}
  .num.available{background:#ffffff;color:#1a1208;border-color:#cccccc}
  .num.selected{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#1b1208;border-color:rgba(0,0,0,.2)}
  .num.sold{background:#22c55e;color:#ffffff;cursor:not-allowed;border-color:#16a34a}
  .num.pending{background:#ffa500;color:#1a1208;cursor:not-allowed;border-color:#f59e0b}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .toolbar input[type="number"]{width:100px;background:transparent;border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:8px 10px;color:var(--text)}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--accent),#ff9933);color:#1a1208;box-shadow:var(--shadow)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.3);color:var(--text)}
  .btn:active{transform:translateY(1px)}
  .row{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .status{font-size:13px;opacity:.9}
  .progress{height:12px;background:rgba(255,255,255,.18);border-radius:999px;overflow:hidden}
  .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--ok),#86efac);width:0%}
  .total{font-weight:800}
  .warn{font-size:12px;opacity:.85}
  .depo{display:grid;gap:10px}
  .depo .item{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:12px}
  footer{margin:24px auto 28px;text-align:center;opacity:.85}
  
  /* PIX Info */
  .pix-info{background:linear-gradient(135deg,var(--ok),#86efac);color:#0a1b0f;border-radius:var(--radius);padding:16px;margin:12px 0;border:2px solid #22c55e}
  .pix-key{display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.1);border-radius:8px;padding:8px 12px;margin:8px 0;font-family:monospace;font-weight:bold;font-size:16px}
  .copy-btn{background:rgba(0,0,0,.2);border:none;color:#0a1b0f;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:bold}
  .copy-btn:hover{background:rgba(0,0,0,.3)}
  
  /* Admin Panel */
  .admin-panel{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(10,27,63,.95);z-index:1000;overflow-y:auto}
  .admin-content{max-width:800px;margin:20px auto;background:var(--card);border-radius:var(--radius);padding:20px}
  .admin-login{max-width:300px;margin:200px auto;background:var(--card);border-radius:var(--radius);padding:30px;text-align:center}
  .admin-login input{width:100%;padding:12px;margin:10px 0;border:1px solid rgba(255,255,255,.3);background:transparent;color:var(--text);border-radius:8px}
  .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,.2);padding-bottom:15px}
  .admin-orders{display:grid;gap:12px}
  .admin-order{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:15px}
  .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .order-numbers{display:flex;flex-wrap:wrap;gap:4px;margin:8px 0}
  .order-number{background:var(--accent);color:#1a1208;padding:2px 6px;border-radius:4px;font-size:11px;font-weight:bold}
  .order-actions{display:flex;gap:8px;margin-top:10px}
  .btn-success{background:var(--ok);color:#0a1b0f}
  .btn-danger{background:var(--danger);color:white}
  .admin-toggle{position:fixed;top:20px;right:20px;background:var(--muted);color:var(--text);border:1px solid rgba(255,255,255,.3);border-radius:8px;padding:8px 12px;cursor:pointer;z-index:999;font-size:12px}
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }
  
  .sorteio-winner {
    background:linear-gradient(135deg,#FFD700,#FFA500);
    color:#1a1208;
    padding:12px;
    border-radius:12px;
    margin:8px 0;
    border:2px solid #ff7a00
  }
  
  .sorteio-public {
    background:linear-gradient(135deg,var(--ok),#86efac);
    color:#0a1b0f;
    border-radius:var(--radius);
    padding:16px;
    margin:16px 0;
    border:2px solid #22c55e;
    text-align:center
  }
  
  .num:focus-visible,.btn:focus-visible,input:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
</style>
</head>
<body>
<button class="admin-toggle" onclick="toggleAdmin()">‚öôÔ∏è Admin</button>

<div id="adminPanel" class="admin-panel">
  <div id="adminLogin" class="admin-login">
    <h3>Login Admin</h3>
    
    <!-- Campo para o email -->
    <input type="email" id="adminEmail" placeholder="Digite o seu email" />
    
    <!-- Campo para a senha -->
    <input type="password" id="adminPassword" placeholder="Digite a sua senha" />
    
    <!-- Bot√£o de login -->
    <button class="btn btn-primary" onclick="loginAdmin()" style="width:100%;margin-top:15px">
      Entrar
    </button>
    
    <!-- Cancelar volta ao site -->
    <button class="btn btn-ghost" onclick="toggleAdmin()" style="width:100%;margin-top:8px">
      Cancelar
    </button>
  </div>
  
  <div id="adminContent" class="admin-content" style="display:none">
    <div class="admin-header">
      <h2>Painel Admin</h2>
      <button class="btn btn-danger" onclick="logoutAdmin()">Sair</button>
    </div>
    
    <div class="card">
      <h3>Pedidos Pendentes</h3>
      <div id="adminOrders" class="admin-orders"></div>
    </div>
    
    <div class="card" style="margin-top:16px">
      <h3>Estat√≠sticas</h3>
      <div id="adminStats"></div>
    </div>
    
    <div class="card" style="margin-top:16px">
      <h3>‚öôÔ∏è Configura√ß√µes da Rifa</h3>
      <div style="display:grid;gap:12px">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="premio1" type="number" placeholder="1¬∫ Pr√™mio (R$)" style="padding:8px;border:1px solid rgba(255,255,255,.3);background:transparent;color:var(--text);border-radius:8px" />
          <input id="premio2" type="number" placeholder="2¬∫ Pr√™mio (R$)" style="padding:8px;border:1px solid rgba(255,255,255,.3);background:transparent;color:var(--text);border-radius:8px" />
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="premio3" type="number" placeholder="3¬∫ Pr√™mio (R$)" style="padding:8px;border:1px solid rgba(255,255,255,.3);background:transparent;color:var(--text);border-radius:8px" />
          <select id="qtdPremios" style="padding:8px;border:1px solid rgba(255,255,255,.3);background:var(--card);color:var(--text);border-radius:8px">
            <option value="1">1 Pr√™mio</option>
            <option value="2">2 Pr√™mios</option>
            <option value="3" selected>3 Pr√™mios</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="salvarConfiguracoes()" style="background:#4f46e5;color:#ffffff">
          üíæ Salvar Configura√ß√µes
        </button>
      </div>
    </div>
    
    <div class="card" style="margin-top:16px">
      <h3>üéÆ A√ß√µes da Rifa</h3>
      <div style="display:grid;gap:12px">
        <button class="btn btn-ghost" onclick="limparNumerosPagos()" style="background:#ffa500;color:#1a1208">
          üîÑ Limpar Todos os N√∫meros Pagos
        </button>
        <button class="btn btn-danger" onclick="resetarRifaCompleta()">
          üóëÔ∏è Resetar Rifa Completa
        </button>
        <button class="btn btn-primary" onclick="realizarSorteio()" style="background:#22c55e;color:#ffffff">
          üé≤ Realizar Sorteio
        </button>
      </div>
    </div>
    
    <div class="card" style="margin-top:16px">
      <h3>üóëÔ∏è Gerenciar N√∫meros Pagos</h3>
      <div id="numerosPagosLista" style="display:grid;gap:8px;max-height:200px;overflow-y:auto">
        <p style="opacity:0.7">Nenhum n√∫mero pago ainda</p>
      </div>
    </div>
    
    <div class="card" style="margin-top:16px">
      <h3>üèÜ Resultados do Sorteio</h3>
      <div id="sorteioResults"></div>
    </div>
  </div>
</div>

<header>
  <h1>Pix da Sorte @LeehFerriiOficial ‚Äî Online e Profissional</h1>
  <p>Sorteio autom√°tico √†s 18h do dia seguinte ap√≥s esgotar os n√∫meros.</p>
  <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Avalia√ß√£o m√°xima</div>
  <div id="liveIndicator" style="margin-top:8px;padding:6px 12px;background:#22c55e;border-radius:20px;display:inline-block;font-size:12px;font-weight:bold;animation:pulse 2s infinite">
    üî¥ AO VIVO
  </div>
</header>

<div class="container">
  <section class="grid">
    <div id="rifas"></div>

    <div class="card">
      <h3 style="margin:0 0 8px 0">Transpar√™ncia e Regras</h3>
      <ul style="margin:8px 0 0 18px;line-height:1.5">
        <li>Todas as rifas possuem <strong>100 n√∫meros</strong>, sem desconto por quantidade.</li>
        <li>Pagamento via PIX indicado no WhatsApp. Envio autom√°tico dos seus n√∫meros por mensagem.</li>
        <li>Quando todos os n√∫meros estiverem vendidos, o sistema agenda o sorteio para <strong>18:00 do dia seguinte</strong>.</li>
        <li>Premia√ß√µes fixas: <strong>1¬∫ lugar R$ 500,00</strong> ‚Ä¢ <strong>2¬∫ lugar R$ 200,00</strong>.</li>
        <li>A arrecada√ß√£o e o valor destinado √† organiza√ß√£o s√£o mostrados na tela (arrecada√ß√£o ‚Äì pr√™mios).</li>
      </ul>
      <p class="warn" style="margin-top:8px">Obs.: Todos os n√∫meros est√£o dispon√≠veis para compra. Quando voc√™ efetua uma compra, os n√∫meros selecionados ficam indispon√≠veis para outros compradores.</p>
    </div>

    <div class="card depo">
      <h3 style="margin:0">Depoimentos</h3>
      <div class="item">"Participei e recebi meus n√∫meros na hora pelo WhatsApp. Top!" ‚Äî <strong>J√©ssica R.</strong></div>
      <div class="item">"Site leve e r√°pido no celular. Acompanhei o sorteio sem dor de cabe√ßa." ‚Äî <strong>Rafael D.</strong></div>
      <div class="item">"Transparente: mostra quanto j√° foi vendido e o pr√™mio garantido." ‚Äî <strong>Anderson M.</strong></div>
    </div>
  </section>

  <footer>
    <p>&copy; <span id="year"></span> Pix da Sorte @LeehFerriiOficial</p>
  </footer>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const WHATSAPP_NUMBER = "5511960671570";
const PIX_KEY = "11960671570";
const ADMIN_PASSWORD = "Ccjj9842#";

const RIFAS_DATA = [
  { 
    id: 1, 
    nome: "Pix da Sorte Premium", 
    premios: { primeiro: 500, segundo: 200 },
    preco: 15, 
    total: 100 
  }
];

document.getElementById('year').textContent = new Date().getFullYear();

const brl = v => v.toLocaleString('pt-BR',{style:'currency', currency:'BRL'});

// Firebase config e inicializa√ß√£o
const firebaseConfig = {
  apiKey: "AIzaSyBB8kbcu13tZxdgGtBFGk7CUtdotW-9noI",
  authDomain: "pix-da-sorte-app1.firebaseapp.com",
  databaseURL: "https://pix-da-sorte-app1-default-rtdb.firebaseio.com",
  projectId: "pix-da-sorte-app1",
  storageBucket: "pix-da-sorte-app1.firebasestorage.app",
  messagingSenderId: "946509858198",
  appId: "1:946509858198:web:c187a66bec884b5b4d89b7"
};

const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database(app);

let adminOrders = [];
let adminState = {numbers: {}, sorteio: null, config:{premios:[500,200,100], qtdPremios:3}};

// Fun√ß√£o para salvar dados no Firebase
function saveAdminData() {
  // Salva adminOrders e adminState no banco Firebase
  database.ref('adminOrders').set(adminOrders);
  database.ref('adminState').set(adminState);
}

// Fun√ß√£o para carregar dados do Firebase ao iniciar
function loadAdminData() {
  database.ref('adminOrders').once('value').then(snapshot => {
    adminOrders = snapshot.val() || [];
    updateAdminPanel();
  });
  database.ref('adminState').once('value').then(snapshot => {
    adminState = snapshot.val() || {numbers: {}, sorteio: null, config:{premios:[500,200,100], qtdPremios:3}};
  });
}

// Listener para atualiza√ß√µes em tempo real
database.ref('adminOrders').on('value', snapshot => {
  adminOrders = snapshot.val() || [];
  updateAdminPanel();
});

database.ref('adminState').on('value', snapshot => {
  adminState = snapshot.val() || {numbers: {}, sorteio: null, config:{premios:[500,200,100], qtdPremios:3}};
  // Atualiza a interface p√∫blica se necess√°rio
  window.dispatchEvent(new Event('rifaStateChanged'));
});

// Fun√ß√£o para adicionar pedido admin
function addAdminOrder(numbers, metadata) {
  const order = {
    id: Date.now(),
    numbers: numbers,
    timestamp: metadata.timestamp,
    status: 'pending',
    customerName: metadata.customerName,
    customerWhatsApp: metadata.customerWhatsApp
  };
  
  numbers.forEach(num => {
    adminState.numbers[num] = {
      status: 'pending',
      orderId: order.id,
      timestamp: order.timestamp,
      customerName: metadata.customerName,
      customerWhatsApp: metadata.customerWhatsApp
    };
  });
  
  adminOrders.push(order);
  saveAdminData();
}

window.addAdminOrder = addAdminOrder;

function toggleAdmin() {
  const panel = document.getElementById('adminPanel');
  panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
  if(panel.style.display === 'block') {
    document.getElementById('adminEmail').focus();
  }
}

function loginAdmin() {
  const email = document.getElementById('adminEmail').value;
  const password = document.getElementById('adminPassword').value;
  if(password === ADMIN_PASSWORD) {
    document.getElementById('adminLogin').style.display = 'none';
    document.getElementById('adminContent').style.display = 'block';
    updateAdminPanel();
  } else {
    alert('Senha incorreta!');
  }
}

function logoutAdmin() {
  document.getElementById('adminLogin').style.display = 'block';
  document.getElementById('adminContent').style.display = 'none';
  document.getElementById('adminEmail').value = '';
  document.getElementById('adminPassword').value = '';
  toggleAdmin();
}

function confirmPayment(orderId) {
  const order = adminOrders.find(o => o.id === orderId);
  if(order) {
    order.status = 'confirmed';
    order.numbers.forEach(num => {
      adminState.numbers[num] = {
        status: 'paid',
        orderId: orderId,
        timestamp: order.timestamp,
        customerName: order.customerName,
        customerWhatsApp: order.customerWhatsApp
      };
    });
    saveAdminData();
    updateAdminPanel();
    alert('Pagamento confirmado!');
  }
}

function cancelOrder(orderId) {
  const order = adminOrders.find(o => o.id === orderId);
  if(order && confirm('Cancelar pedido?')) {
    order.status = 'cancelled';
    order.numbers.forEach(num => {
      if(adminState.numbers[num] && adminState.numbers[num].orderId === orderId) {
        delete adminState.numbers[num];
      }
    });
    saveAdminData();
    updateAdminPanel();
    alert('Pedido cancelado!');
  }
}

function updateAdminPanel() {
  const ordersEl = document.getElementById('adminOrders');
  const statsEl = document.getElementById('adminStats');
  const sorteioEl = document.getElementById('sorteioResults');
  
  const pendingOrders = adminOrders.filter(o => o.status === 'pending');
  ordersEl.innerHTML = pendingOrders.length === 0 ? 
    '<p style="opacity:0.7">Nenhum pedido pendente</p>' :
    pendingOrders.map(order => `
      <div class="admin-order">
        <div class="order-header">
          <strong>Pedido #${order.id}</strong>
          <small>${new Date(order.timestamp).toLocaleString('pt-BR')}</small>
        </div>
        <div class="order-numbers">
          ${order.numbers.map(n => `<span class="order-number">${n}</span>`).join('')}
        </div>
        <p><strong>Total: ${brl(order.numbers.length * 15)}</strong></p>
        <p><strong>Cliente:</strong> ${order.customerName} ‚Ä¢ <strong>WhatsApp:</strong> ${order.customerWhatsApp}</p>
        <div class="order-actions">
          <button class="btn btn-success" onclick="confirmPayment(${order.id})">Confirmar</button>
          <button class="btn btn-danger" onclick="cancelOrder(${order.id})">Cancelar</button>
        </div>
      </div>
    `).join('');
  
  const paidNumbers = Object.values(adminState.numbers).filter(n => n.status === 'paid').length;
  const pendingNumbers = Object.values(adminState.numbers).filter(n => n.status === 'pending').length;
  const revenue = paidNumbers * 15;
  
  statsEl.innerHTML = `
    <div class="row">
      <div>Vendidos: <strong>${paidNumbers}/100</strong></div>
      <div>Pendentes: <strong>${pendingNumbers}</strong></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>Arrecada√ß√£o: <strong>${brl(revenue)}</strong></div>
      <div>Lucro: <strong>${brl(revenue - 700)}</strong></div>
    </div>
  `;
  
  if(adminState.sorteio) {
    sorteioEl.innerHTML = `
      <div class="sorteio-winner">
        <h4 style="margin:0 0 8px 0">üèÜ Resultados</h4>
        <p><strong>ü•á 1¬∫ Lugar:</strong> #${adminState.sorteio.primeiro.numero} - ${adminState.sorteio.primeiro.nome} (${adminState.sorteio.primeiro.whatsapp})</p>
        <p><strong>ü•à 2¬∫ Lugar:</strong> #${adminState.sorteio.segundo.numero} - ${adminState.sorteio.segundo.nome} (${adminState.sorteio.segundo.whatsapp})</p>
        <p><strong>ü•â 3¬∫ Lugar:</strong> #${adminState.sorteio.terceiro.numero} - ${adminState.sorteio.terceiro.nome} (${adminState.sorteio.terceiro.whatsapp})</p>
        <small>Sorteio realizado em: ${new Date(adminState.sorteio.timestamp).toLocaleString('pt-BR')}</small>
      </div>
    `;
  } else {
    sorteioEl.innerHTML = '<p style="opacity:0.7">Nenhum sorteio realizado ainda</p>';
  }
}

function limparPedidosExpirados() {
  const agora = Date.now();
  const limite = 30 * 60 * 1000; // 30 minutos em ms
  let mudou = false;

  adminOrders.forEach(order => {
    if (order.status === 'pending') {
      const timestampPedido = new Date(order.timestamp).getTime();
      if (agora - timestampPedido > limite) {
        order.status = 'cancelled';
        order.numbers.forEach(num => {
          if (adminState.numbers[num] && adminState.numbers[num].orderId === order.id) {
            delete adminState.numbers[num];
          }
        });
        mudou = true;
      }
    }
  });

  if (mudou) {
    saveAdminData();
    updateAdminPanel();
  }
}

function limparNumerosPagos() {
  if(!confirm('Tem certeza que deseja limpar todos os n√∫meros pagos? Esta a√ß√£o n√£o pode ser desfeita.')) return;
  
  Object.keys(adminState.numbers).forEach(num => {
    if(adminState.numbers[num].status === 'paid') {
      delete adminState.numbers[num];
    }
  });
  
  adminOrders = adminOrders.filter(order => order.status !== 'confirmed');
  
  saveAdminData();
  updateAdminPanel();
  alert('N√∫meros pagos removidos com sucesso!');
}

function resetarRifaCompleta() {
  if(!confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° resetar TODA a rifa (n√∫meros, pedidos, sorteios). Tem certeza?')) return;
  if(!confirm('üö® CONFIRMA√á√ÉO FINAL: Todos os dados ser√£o perdidos permanentemente. Continuar?')) return;
  
  adminState = {numbers: {}, sorteio: null, config:{premios:[500,200,100], qtdPremios:3}};
  adminOrders = [];
  
  saveAdminData();
  updateAdminPanel();
  alert('Rifa resetada completamente!');
}

function realizarSorteio() {
  const numerosPagos = Object.keys(adminState.numbers).filter(num => 
    adminState.numbers[num].status === 'paid'
  ).map(num => parseInt(num));
  
  if(numerosPagos.length < 3) {
    alert('√â necess√°rio ter pelo menos 3 n√∫meros pagos para realizar o sorteio.');
    return;
  }
  
  if(!confirm(`Realizar sorteio com ${numerosPagos.length} n√∫meros pagos?`)) return;
  
  const shuffled = [...numerosPagos].sort(() => Math.random() - 0.5);
  
  const primeiro = shuffled[0];
  const segundo = shuffled[1];
  const terceiro = shuffled[2];
  
  adminState.sorteio = {
    primeiro: {
      numero: primeiro,
      nome: adminState.numbers[primeiro].customerName,
      whatsapp: adminState.numbers[primeiro].customerWhatsApp
    },
    segundo: {
      numero: segundo,
      nome: adminState.numbers[segundo].customerName,
      whatsapp: adminState.numbers[segundo].customerWhatsApp
    },
    terceiro: {
      numero: terceiro,
      nome: adminState.numbers[terceiro].customerName,
      whatsapp: adminState.numbers[terceiro].customerWhatsApp
    },
    timestamp: new Date().toISOString()
  };
  
  saveAdminData();
  updateAdminPanel();
  alert('üéâ Sorteio realizado com sucesso!');
}

document.addEventListener('DOMContentLoaded', () => {
  limparPedidosExpirados();
  setInterval(limparPedidosExpirados, 300000); // 5 minutos
  
  setInterval(() => {
    window.dispatchEvent(new Event('rifaStateChanged'));
  }, 1500);
});

function copyPixKey() {
  navigator.clipboard.writeText(PIX_KEY).then(() => {
    const btn = event.target;
    btn.textContent = 'Copiado!';
    btn.style.background = 'rgba(34, 197, 94, 0.3)';
    setTimeout(() => {
      btn.textContent = 'Copiar';
      btn.style.background = 'rgba(0,0,0,.2)';
    }, 2000);
  }).catch(() => {
    alert('Chave PIX: ' + PIX_KEY);
  });
}

function renderRifa(data){
  const rifa = { ...data, vendidos: new Set(), vencedores: null };

  const wrap = document.createElement('div');
  wrap.className = 'card rifa';
  wrap.innerHTML = `
    <div class="row">
      <h2>${rifa.nome}</h2>
    </div>

    <div class="share-buttons" style="margin:12px 0; display:flex; gap:10px; flex-wrap: wrap;">
      <button class="btn btn-ghost share-whatsapp" style="background:#25D366; color:white;">WhatsApp</button>
      <button class="btn btn-ghost share-facebook" style="background:#1877F2; color:white;">Facebook</button>
      <button class="btn btn-ghost share-twitter" style="background:#1DA1F2; color:white;">Twitter</button>
      <button class="btn btn-ghost share-instagram" style="background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%); color:white;">Instagram</button>
      <button class="btn btn-ghost share-tiktok" style="background:#000000; color:white;">TikTok</button>
    </div>

    <div class="pill">Valor: <strong>${brl(rifa.preco)}</strong></div>

    <div class="meta">
      <span class="pill" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #1a1208;">ü•á ${brl(rifa.premios.primeiro)}</span>
      <span class="pill" style="background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: #1a1208;">ü•à ${brl(rifa.premios.segundo)}</span>
    </div>
    <div class="meta">
      <span class="pill" id="cap-${rifa.id}"></span>
      <span class="pill" id="org-${rifa.id}"></span>
    </div>

    <div class="pix-info">
      <h4 style="margin:0 0 8px 0;color:#0a1b0f">üí≥ PIX para Pagamento</h4>
      <div class="pix-key">
        <span>${PIX_KEY}</span>
        <button class="copy-btn" onclick="copyPixKey()">Copiar</button>
      </div>
      <p style="margin:8px 0 4px 0;color:#0a1b0f;font-size:13px">
        ‚úÖ Ap√≥s pagar, envie comprovante no WhatsApp<br>
        ‚è±Ô∏è N√∫meros reservados por 30 minutos
      </p>
    </div>

    <div class="legend">
      <span><span class="dot" style="background:#ffffff;border:1px solid #ccc"></span>Dispon√≠vel</span>
      <span><span class="dot" style="background:linear-gradient(180deg,var(--accent),var(--accent-2))"></span>Selecionado</span>
      <span><span class="dot" style="background:#ffa500"></span>Aguardando</span>
      <span><span class="dot" style="background:#22c55e"></span>Pago</span>
    </div>

    <div class="row">
      <div class="status" id="status-${rifa.id}"></div>
      <div class="total" id="total-${rifa.id}"></div>
    </div>
    <div class="progress"><span id="pb-${rifa.id}"></span></div>

    <div id="sorteioPublico-${rifa.id}"></div>
    
    <div class="numbers" id="nums-${rifa.id}"></div>

    <div class="toolbar" style="display:grid;gap:10px;">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <input id="qtd-${rifa.id}" type="number" min="1" max="${rifa.total}" value="1" />
        <button class="btn btn-ghost" id="gerar-${rifa.id}">Gerar</button>
      </div>
      <div style="display:grid;gap:8px;">
        <input id="nome-${rifa.id}" type="text" placeholder="Seu nome completo" style="width:100%;background:transparent;border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:8px 10px;color:var(--text)" required />
        <input id="whatsapp-${rifa.id}" type="tel" placeholder="WhatsApp (11999999999)" style="width:100%;background:transparent;border:1px solid rgba(255,255,255,.3);border-radius:10px;padding:8px 10px;color:var(--text)" required />
      </div>
      <button class="btn btn-primary" id="comprar-${rifa.id}">Comprar N√∫meros</button>
    </div>
  `;

  document.getElementById('rifas').appendChild(wrap);

  const numsEl = wrap.querySelector('#nums-'+rifa.id);
  const statusEl = wrap.querySelector('#status-'+rifa.id);
  const totalEl = wrap.querySelector('#total-'+rifa.id);
  const pbEl = wrap.querySelector('#pb-'+rifa.id);
  const capEl = wrap.querySelector('#cap-'+rifa.id);
  const orgEl = wrap.querySelector('#org-'+rifa.id);
  const qtdEl = wrap.querySelector('#qtd-'+rifa.id);

  const selecionados = new Set();

  for(let i=1;i<=rifa.total;i++){
    const b = document.createElement('button');
    b.type='button';
    b.className='num available';
    b.textContent = i;
    b.dataset.n = i;
    b.addEventListener('click', ()=>{
      if(b.classList.contains('sold') || b.classList.contains('pending')) return;
      const n = Number(b.dataset.n);
      if(selecionados.has(n)){
        selecionados.delete(n);
        b.classList.remove('selected');
        b.classList.add('available');
      }else{
        selecionados.add(n);
        b.classList.remove('available');
        b.classList.add('selected');
      }
      atualizarTotais();
    });
    numsEl.appendChild(b);
  }

  function disponiveis(){
    const arr=[];
    numsEl.querySelectorAll('.num.available').forEach(el=> arr.push(Number(el.dataset.n)));
    return arr;
  }

  function atualizarStatus(){
    const vendidos = numsEl.querySelectorAll('.num.sold').length;
    const pendentes = numsEl.querySelectorAll('.num.pending').length;
    const disp = numsEl.querySelectorAll('.num.available').length;
    const pct = Math.round((vendidos / rifa.total)*100);
    
    statusEl.textContent = `Dispon√≠veis: ${disp} ‚Ä¢ Vendidos: ${vendidos} ‚Ä¢ Aguardando: ${pendentes}`;
    pbEl.style.width = pct + '%';
    
    const arrecadacao = vendidos * rifa.preco;
    const saldo = arrecadacao - 700;
    capEl.textContent = `Arrecada√ß√£o: ${brl(arrecadacao)}`;
    orgEl.textContent = `Lucro: ${brl(saldo)}`;
  }

  function atualizarTotais(){
    const qtd = Number(qtdEl.value)||0;
    totalEl.textContent = `Selecionados: ${selecionados.size} ‚Ä¢ Total: ${brl(rifa.preco * Math.max(qtd, selecionados.size||0))}`;
    atualizarStatus();
  }

  wrap.querySelector('#gerar-'+rifa.id).addEventListener('click', ()=>{
    const qtd = Math.max(1, Math.min(Number(qtdEl.value)||1, rifa.total));
    selecionados.clear();
    numsEl.querySelectorAll('.num.selected').forEach(el=>{
      el.classList.remove('selected'); el.classList.add('available');
    });
    const disp = disponiveis();
    if(disp.length < qtd){
      alert('Quantidade indispon√≠vel.');
      return;
    }
    for(let i=0;i<qtd;i++){
      const idx = Math.floor(Math.random()*disp.length);
      const n = disp.splice(idx,1)[0];
      selecionados.add(n);
      const btn = numsEl.querySelector(`[data-n="${n}"]`);
      btn.classList.remove('available'); 
      btn.classList.add('selected');
    }
    atualizarTotais();
  });

  wrap.querySelector('#comprar-'+rifa.id).addEventListener('click', ()=>{
    const nomeInput = wrap.querySelector('#nome-'+rifa.id);
    const whatsappInput = wrap.querySelector('#whatsapp-'+rifa.id);
    const nome = nomeInput.value.trim();
    const whatsapp = whatsappInput.value.trim();

    if(!nome) {
      alert('Por favor, informe seu nome completo.');
      nomeInput.focus();
      return;
    }

    if(!whatsapp || !/^\d{10,15}$/.test(whatsapp.replace(/\D/g,''))) {
      alert('Por favor, informe um n√∫mero de WhatsApp v√°lido (apenas n√∫meros, 10 a 15 d√≠gitos).');
      whatsappInput.focus();
      return;
    }

    const qtdDesejada = Math.max(1, Math.min(Number(qtdEl.value)||1, rifa.total));
    let escolhidos = Array.from(selecionados);

    if(escolhidos.length < qtdDesejada){
      const faltam = qtdDesejada - escolhidos.length;
      const disp = disponiveis().filter(n => !selecionados.has(n));
      if(disp.length < faltam){
        alert('N√∫meros insuficientes.');
        return;
      }
      for(let i=0;i<faltam;i++){
        const idx = Math.floor(Math.random()*disp.length);
        escolhidos.push(disp.splice(idx,1)[0]);
      }
    }

    escolhidos.forEach(n=>{
      const el = numsEl.querySelector(`[data-n="${n}"]`);
      el.classList.remove('available','selected'); 
      el.classList.add('pending');
      selecionados.delete(n);
    });

    if(window.addAdminOrder) {
      window.addAdminOrder(escolhidos, {
        timestamp: new Date().toISOString(),
        customerName: nome,
        customerWhatsApp: whatsapp
      });
    }

    const total = escolhidos.length * rifa.preco;
    const msg = [
      `*${rifa.nome}*`,
      `N√∫meros: ${escolhidos.sort((a,b)=>a-b).join(', ')}`,
      `Qtde: ${escolhidos.length}`,
      `*Total: ${brl(total)}*`,
      ``,
      `ü•á ${brl(rifa.premios.primeiro)} | ü•à ${brl(rifa.premios.segundo)}`,
      ``,
      `PIX: ${PIX_KEY}`,
      `Envie o comprovante aqui!`
    ].join('\n');

    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');

    alert('N√∫meros reservados! Complete o pagamento via WhatsApp.');
    atualizarTotais();
  });

  function shareWhatsApp() {
    const text = encodeURIComponent(`Participe da rifa *${rifa.nome}*! S√£o 100 n√∫meros, cada unid. ${brl(rifa.preco)}, com pr√™mios de ${brl(rifa.premios.primeiro)} e ${brl(rifa.premios.segundo)}. Compre seu n√∫mero e boa sorte! Link: ${window.location.href}`);
    const url = `https://wa.me/?text=${text}`;
    window.open(url, '_blank');
  }

  function shareFacebook() {
    const url = encodeURIComponent(window.location.href);
    const fbShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
    window.open(fbShareUrl, '_blank');
  }

  function shareTwitter() {
    const text = encodeURIComponent(`Participe da rifa ${rifa.nome}! Pr√™mios incr√≠veis e muita sorte. Confira:`);
    const url = encodeURIComponent(window.location.href);
    const twitterUrl = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
    window.open(twitterUrl, '_blank');
  }

  function copyLink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
      alert('Link copiado para a √°rea de transfer√™ncia!');
    }).catch(() => {
      alert('Copie o link manualmente: ' + url);
    });
  }

  function shareInstagram() {
    copyLink();
  }

  function shareTikTok() {
    copyLink();
  }

  wrap.querySelector('.share-whatsapp').onclick = shareWhatsApp;
  wrap.querySelector('.share-facebook').onclick = shareFacebook;
  wrap.querySelector('.share-twitter').onclick = shareTwitter;
  wrap.querySelector('.share-instagram').onclick = shareInstagram;
  wrap.querySelector('.share-tiktok').onclick = shareTikTok;

  function loadRifaState() {
    const state = adminState; // agora vem do Firebase
    updateRifaDisplay(state);
  }

  function updateRifaDisplay(adminState) {
    if(!adminState || !adminState.numbers) return;
    
    Object.keys(adminState.numbers).forEach(numStr => {
      const num = parseInt(numStr);
      const numState = adminState.numbers[numStr];
      const numEl = numsEl.querySelector(`[data-n="${num}"]`);
      
      if(numEl && numState) {
        numEl.classList.remove('available', 'pending', 'sold', 'selected');
        
        if(numState.status === 'pending') {
          numEl.classList.add('pending');
        } else if(numState.status === 'paid') {
          numEl.classList.add('sold');
        } else {
          numEl.classList.add('available');
        }
      }
    });
    
    const sorteioPublicoEl = wrap.querySelector(`#sorteioPublico-${rifa.id}`);
    if(adminState.sorteio && sorteioPublicoEl) {
      sorteioPublicoEl.innerHTML = `
        <div class="sorteio-public">
          <h4 style="margin:0 0 12px 0">üèÜ RESULTADOS DO SORTEIO</h4>
          <div style="display:grid;gap:8px">
            <div><strong>ü•á 1¬∫ Lugar (${brl(500)}):</strong> #${adminState.sorteio.primeiro.numero} - ${adminState.sorteio.primeiro.nome}</div>
            <div><strong>ü•à 2¬∫ Lugar (${brl(200)}):</strong> #${adminState.sorteio.segundo.numero} - ${adminState.sorteio.segundo.nome}</div>
            <div><strong>ü•â 3¬∫ Lugar:</strong> #${adminState.sorteio.terceiro.numero} - ${adminState.sorteio.terceiro.nome}</div>
          </div>
          <small style="display:block;margin-top:8px">Sorteio realizado em: ${new Date(adminState.sorteio.timestamp).toLocaleString('pt-BR')}</small>
        </div>
      `;
    } else if(sorteioPublicoEl) {
      sorteioPublicoEl.innerHTML = '';
    }
    
    setTimeout(atualizarTotais, 100);
  }

  window.addEventListener('rifaStateChanged', loadRifaState);

  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(loadRifaState, 500);
  });

  setInterval(loadRifaState, 1500);

  atualizarTotais();
}

RIFAS_DATA.forEach(renderRifa);

</script>
</body>

</html>

